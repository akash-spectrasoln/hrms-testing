{% extends 'timesheet_partials/base.html' %}
{% block body_class %}template-body-basic{% endblock %}
{% load static %}

{% block content %}
<div class="container container-page" style="margin-top: 90px;">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-11">

            <div class="card shadow-sm border rounded">
                <div class="card-header bg-primary text-white py-2 d-flex justify-content-between align-items-center">
                    <!-- Title -->
                    <h5 class="card-title mb-0 flex-grow-1 text-center">Project Utilization</h5>

                    <!-- Download & Reset Buttons -->
                    <div class="d-flex align-items-center gap-2">
                        <a id="downloadBtn"
                           href="#"
                           data-url="{% if report_data %}{% url 'export_project_cc_utilization' %}?start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}{% endif %}"
                           class="btn btn-success btn-sm {% if not report_data %}disabled{% endif %}">
                            <i class="fas fa-download"></i> Download Excel
                        </a>
                        <a href="{% url request.resolver_match.url_name %}" class="btn btn-secondary btn-sm">
                            <i class="fas fa-undo"></i> Reset
                        </a>
                    </div>
                </div>

                <div class="card-body p-3">
                    <!-- Filters Row -->
                    <form class="row g-2 align-items-end mb-3" method="GET">
                        <div class="col-sm-6 col-md-3">
                            <label class="form-label mb-1">Start Date</label>
                            <input type="date" id="start_date" name="start_date"
                                   value="{{ start_date|date:'Y-m-d' }}"
                                   min="2025-08-01"
                                   class="form-control form-control-sm">
                        </div>
                        <div class="col-sm-6 col-md-3">
                            <label class="form-label mb-1">End Date</label>
                            <input type="date" id="end_date" name="end_date"
                                   value="{{ end_date|date:'Y-m-d' }}"
                                   min="2025-08-01"
                                   max="{{ today|date:'Y-m-d' }}"
                                   class="form-control form-control-sm">
                        </div>
                        <div class="col-sm-6 col-md-3">
                            <label class="form-label mb-1">Search Employee</label>
                            <input type="text" id="employeeSearch"
                                   class="form-control form-control-sm"
                                   placeholder="ID or Name...">
                        </div>
                        <div class="col-sm-6 col-md-2 d-grid">
                            <button type="submit" class="btn btn-primary btn-sm">Generate</button>
                        </div>
                    </form>

                    <!-- Report Table -->
<div class="table-responsive" style="max-height: 450px; overflow-y: auto;">
    <table class="table table-striped table-hover table-sm align-middle mb-0">
        <thead class="table-light">
            <tr>
                <th>Employee</th>
                <th class="text-end">Weekday Worked</th>
                <th class="text-end">Weekend Worked</th>
                <th class="text-end">Holidays</th>
                <th class="text-end">Leaves</th>
                <th class="text-end">Total Days</th>
                <th class="text-end">Project Days</th>
                <th class="text-end">CC Days</th>
                <th class="text-end">Project Util %</th>
                <th class="text-end">CC Util %</th>
            </tr>
        </thead>
        <tbody id="reportTableBody">
            {% if report_data %}
                {% for entry in report_data %}
                <tr>
                    <td>{{ entry.employee_name }}</td>
                    <td class="text-end">{{ entry.weekday_worked|default:0 }}</td>
                    <td class="text-end">{{ entry.weekend_worked|default:0 }}</td>
                    <td class="text-end">{{ entry.holiday_days|default:0 }}</td>
                    <td class="text-end">{{ entry.leave_days|default:0 }}</td>
                    <td class="text-end">{{ entry.total_working_days|default:0 }}</td>
                    <td class="text-end">{{ entry.project_days|default:0 }}</td>
                    <td class="text-end">{{ entry.cc_days|default:0 }}</td>
                    <td class="text-end">{{ entry.project_utilization|default:0 }}%</td>
                    <td class="text-end">{{ entry.cc_utilization|default:0 }}%</td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="11" class="text-center py-3">
                        {% if request.GET.start_date or request.GET.end_date %}
                            No data found for selected range.
                        {% else %}
                            Choose a date range and click Generate.
                        {% endif %}
                    </td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // Date constraints
    const startInput = document.getElementById('start_date');
    const endInput = document.getElementById('end_date');
    const today = new Date("{{ today|date:'Y-m-d' }}");

    if (startInput && endInput) {
        startInput.max = endInput.value;
        endInput.min = startInput.value;
        endInput.max = today.toISOString().split('T')[0];

        startInput.addEventListener('change', () => {
            endInput.min = startInput.value;
            if (new Date(endInput.value) < new Date(startInput.value)) {
                endInput.value = startInput.value;
            }
        });

        endInput.addEventListener('change', () => {
            startInput.max = endInput.value;
            if (new Date(endInput.value) > today) {
                endInput.value = today.toISOString().split('T')[0];
            }
            if (new Date(startInput.value) > new Date(endInput.value)) {
                startInput.value = endInput.value;
            }
        });
    }

    // Employee Search
    document.getElementById("employeeSearch")?.addEventListener("keyup", function () {
        const searchValue = this.value.toLowerCase();
        const rows = document.querySelectorAll("#reportTableBody tr");

        rows.forEach(row => {
            const employeeCell = row.querySelector("td:first-child");
            if (employeeCell) {
                const text = employeeCell.textContent.toLowerCase();
                row.style.display = text.includes(searchValue) ? "" : "none";
            }
        });
    });

    // Excel download via fetch + Blob
    document.getElementById("downloadBtn")?.addEventListener("click", async function(e) {
        e.preventDefault();
        const url = this.dataset.url;
        if (!url) return;

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error("Download failed");

            const blob = await response.blob();
            const link = document.createElement("a");
            link.href = window.URL.createObjectURL(blob);
            link.download = `Project_CC_Utilization_{{ start_date|date:'Ymd' }}_{{ end_date|date:'Ymd' }}.xlsx`;
            link.click();

        } catch (err) {
            console.error(err);
            alert("Failed to download Excel file");
        }
    });
</script>
{% endblock %}
