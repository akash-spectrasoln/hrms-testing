{% extends 'timesheet_partials/base.html' %}
{% block body_class %}template-body-basic{% endblock %}
{% load static %}

{% block content %}
<style>
    .container {
        margin-top: 100px;
        padding: 40px 20px;
        background-color: #f4f4f9;
    }

    .content-wrapper {
        max-width: 1100px;
        margin: 0 auto;
        position: relative;
        font-family: 'Inter', sans-serif;
        font-size: 0.85rem;
    }

    .leave-card {
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(13, 110, 253, 0.08);
        background: #fff;
        border: 1px solid #d1d7e0;
        overflow: hidden;
    }

    .leave-card .card-header {
        background-color: #3b82f6;
        color: white;
        padding: 0.6rem 0.75rem;
        text-align: center;
        height: 25px;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 0;
        border-radius: 0;
        margin: 0;
    }

    .card-title {
        margin: 0;
        font-size: 0.8rem;
        font-weight: 400;
        line-height: 1;
    }

    .btn-sm {
        padding: 2px 8px;
        font-size: 0.75rem;
        border-radius: 4px;
    }

    #bulkApproveBtn {
        padding: 2px 10px;
        font-size: 0.75rem;
    }

    .table th,
    .table td {
        padding: 0.35rem 0.5rem;
        vertical-align: middle;
    }

    .table thead th {
        font-size: 0.75rem;
    }

    .status-cell .badge {
        font-size: 0.7rem;
        padding: 0.2em 0.45em;
    }

    .form-label {
        font-size: 0.75rem;
        margin-bottom: 0.25rem;
    }

    .form-control,
    .form-select {
        height: 28px;
        padding: 0 0.4rem;
        font-size: 0.75rem;
    }

    /* Prevent wrapping */
    .table th,
    .table td {
        white-space: nowrap;
        vertical-align: middle;
    }

    /* Employee column narrower */
    .table th:nth-child(2),
    .table td:nth-child(2) {
        max-width: 200px;
        width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Week column */
    .table th:nth-child(3),
    .table td:nth-child(3) {
        width: 120px;
        text-align: center;
    }

    /* Equal widths for Weekday â†’ Total */
    .table th:nth-child(4),
    .table th:nth-child(5),
    .table th:nth-child(6),
    .table th:nth-child(7),
    .table th:nth-child(8),
    .table td:nth-child(4),
    .table td:nth-child(5),
    .table td:nth-child(6),
    .table td:nth-child(7),
    .table td:nth-child(8) {
        width: 100px;
        text-align: right;
    }

    /* Status column */
    .table th:nth-child(9),
    .table td:nth-child(9) {
        width: 120px;
        text-align: center;
    }

    /* Actions column wider for 2 buttons */
    .table th:nth-child(10),
    .table td:nth-child(10) {
        width: 120px;
        text-align: center;
    }

    .table th {
        font-weight: 600;
        background-color: #f1f5f9;
        color: #075098;
        letter-spacing: 0.3px;
    }

    /* Action buttons inline */
    .action-buttons {
        display: flex;
        gap: 0.3rem;
        justify-content: flex-end;
    }

    /* Compact buttons */
    .action-buttons .btn {
        min-width: 70px;
    }

    /* Modal styles for timesheet details */
    .modal-dialog.modal-lg {
        max-width: 650px;
    }

    .modal-header,
    .modal-footer {
        padding: 0.5rem 1rem;
    }

    .modal-body {
        padding: 0.5rem 1rem;
    }

    .modal-day-section {
        padding: 0.5rem 0;
        border-bottom: 1px solid #dee2e6;
    }

    .modal-day-section:last-child {
        border-bottom: none;
    }

    .modal-day-section .day-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-day-section .day-header h6 {
        margin: 0;
        font-weight: 300;
        font-size: 0.6rem;
    }

    .modal-day-section .badge {
        font-size: 0.4rem;
    }

    .modal-day-section .entry-details {
        margin-top: 0.10rem;
        margin-left: 1rem;
        font-size: 0.6rem;
    }

    .modal-day-section .entry-details small {
        display: block;
    }

    /* New styles for cleaner display */
    .modal-day-section .details-row {
        display: flex;
        justify-content: space-between;
        gap: 5px;
    }

    .modal-day-section .details-row .detail-item {
        flex: 1;
        text-align: left;
    }

    .modal-day-section .details-row .detail-item strong {
        display: block;
        margin-bottom: 0px;
    }


</style>

<style>
    /* Mobile-specific adjustments */
    @media (max-width: 576px) {
        .container {
            margin-top: 80px;
            padding: 8px;
            font-size: 0.8rem;
        }
        .card-header { height: auto; padding: 0.4rem 0.5rem; }
        .card-title { font-size: 0.9rem; }
        .card-body { padding: 0.5rem; }
        .form-control, .form-select { height: 26px; padding: 0 0.35rem; font-size: 0.7rem; }
        .table-responsive { -webkit-overflow-scrolling: touch; }
        .table th, .table td { padding: 0.3rem 0.4rem; font-size: 0.75rem; }
        /* Relax fixed widths on small screens */
        .table th:nth-child(n), .table td:nth-child(n) { width: auto !important; }
        .action-buttons { gap: 0.25rem; justify-content: center; }
        .action-buttons .btn { min-width: auto; padding: 2px 6px; font-size: 0.7rem; }
    }
</style>

<div class="container">
    <div class="content-wrapper">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-12 col-xl-11">
            <div class="leave-card mt-3 mb-4">

                <div class="card-header">
                    <h4 class="card-title">Open Timesheets</h4>
                </div>

                <div class="card-body p-2">

                    <form class="row g-2 mb-2 align-items-end" method="GET">
                        <div class="col-sm-6 col-md-4">
                            <label class="form-label">Status</label>
                            <select name="status" class="form-select form-select-sm">
                                <option value="Pending" {% if selected_status == 'Pending' %}selected{% endif %}>Pending</option>
                            </select>
                        </div>
                        <div class="col-sm-6 col-md-4">
                            <label class="form-label">Employee</label>
                            <input type="text" name="search" class="form-control form-control-sm" placeholder="Search by Employee ID or Name"
                                value="{{ search_query }}">
                        </div>
                        <div class="col-sm-6 col-md-4 d-flex align-items-end gap-1">
                            <button type="submit" class="btn btn-primary btn-sm flex-fill">Search</button>
                            <button type="button" class="btn btn-success btn-sm flex-fill" id="bulkApproveBtn"
                                disabled>Approve Selected</button>
                        </div>
                    </form>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="text-center" style="width: 30px;"><input type="checkbox" id="select_all"></th>
                                    <th>Employee</th>
                                    <th class="text-center">Week</th>
                                    <th class="text-end">Weekday Hrs</th>
                                    <th class="text-end">Leaves</th>
                                    <th class="text-end">Holidays</th>
                                    <th class="text-end">Weekend Hrs</th>
                                    <th class="text-end">Total</th>
                                    <th class="text-center">Status</th>
                                    <th class="text-center" style="width: 90px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in timesheet_data %}
                                <tr id="row-{{ entry.employee.id }}-{{ entry.year }}-{{ entry.week_num }}">
                                    <td class="text-center">
                                        {% if not entry.is_fully_approved and entry.can_approve %}
                                        <input type="checkbox" class="employee-checkbox"
                                            value="{{ entry.employee.id }}-{{ entry.year }}-{{ entry.week_num }}">
                                        {% else %}
                                        <input type="checkbox" disabled>
                                        {% endif %}
                                    </td>
                                    <td>{{ entry.employee.employee_id }} - {{ entry.employee.first_name }} {{ entry.employee.last_name }}</td>
                                    <td class="text-center">
                                        <small>
                                            {{ entry.week_start|date:"M d" }} - {{ entry.week_end|date:"M d" }}<br>
                                            {{ entry.year }}
                                        </small>
                                    </td>
                                    <td class="text-end">{{ entry.weekday_hours }}</td>
                                    <td class="text-end">{{ entry.num_leaves }}</td>
                                    <td class="text-end">{{ entry.num_holidays }}</td>
                                    <td class="text-end">{{ entry.weekend_hours }}</td>
                                    <td class="text-end">{{ entry.total_hours }}</td>
                                    <td class="text-center status-cell">
                                        {% if not entry.has_timesheets %}
                                        <span class="badge bg-secondary text-dark">No Data</span>
                                        {% elif entry.is_fully_approved %}
                                        <span class="badge bg-success">Approved</span>
                                        {% elif entry.can_approve %}
                                        <span class="badge bg-warning text-dark">Pending</span>
                                        {% else %}
                                        <span class="badge bg-danger">Incomplete</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <div class="action-buttons">
                                            {% if entry.is_fully_approved %}
                                                <form action="{% url 'timesheet_unapprove' tsheet_id=entry.tsheet_id %}?next={{ request.get_full_path|urlencode }}" 
                                                    method="post" style="display:inline;">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-warning btn-sm unapprove-btn" data-tsheet-id="{{ entry.tsheet_id }}">
                                                        Back to Edit
                                                    </button>
                                                </form>
                                            {% elif entry.has_timesheets and entry.can_approve %}
                                                <button type="button" class="btn btn-sm btn-outline-success approve-btn"
                                                    data-employee-id="{{ entry.employee.id }}"
                                                    data-week="{{ entry.week_num }}" 
                                                    data-year="{{ entry.year }}">
                                                    Approve
                                                </button>
                                            {% endif %}

                                            <!-- View button ALWAYS last -->
                                            <button type="button" class="btn btn-sm btn-info view-details-btn"
                                                data-employee-id="{{ entry.employee.id }}"
                                                data-week="{{ entry.week_num }}" 
                                                data-year="{{ entry.year }}"
                                                data-week-start="{{ entry.week_start|date:'Y-m-d' }}"
                                                data-week-end="{{ entry.week_end|date:'Y-m-d' }}"
                                                data-employee-name="{{ entry.employee.first_name }} {{ entry.employee.last_name }}"
                                                data-employee-code="{{ entry.employee.employee_id }}">
                                                View
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="10" class="text-center py-2">No pending timesheets found for late submissions.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
    <div id="toastContainer"></div>
</div>

<div class="modal fade" id="weekDetailsModal" tabindex="-1" aria-labelledby="weekDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="weekDetailsModalLabel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    // --- CSRF Token Handling ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie("csrftoken");

    $.ajaxSetup({
        headers: { "X-CSRFToken": csrftoken }
    });

    // --- Toast Notifications (placeholder) ---
    function showToast(message, type = "success") {
        console.log(`[${type}] ${message}`);
        // Replace with your bootstrap/toast logic
    }

    // --- Main ---
    $(function () {
        // Select all checkboxes
        $('#select_all').on('change', function () {
            $('.employee-checkbox').prop('checked', $(this).is(':checked')).trigger('change');
        });

        $('.employee-checkbox').on('change', function () {
            $('#bulkApproveBtn').prop('disabled', $('.employee-checkbox:checked').length === 0);
        });

        // --- Single Approve ---
        $(document).on('click', '.approve-btn', function (e) {
            e.preventDefault();
            const btn = $(this);
            const empId = btn.data('employee-id');
            const year = btn.data('year');
            const week = btn.data('week');

            btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span>');

            const formData = new FormData();
            formData.append('employee_id', empId);
            formData.append('year', year);
            formData.append('week', week + 1); // Convert 0-based to 1-based week
            formData.append('csrfmiddlewaretoken', csrftoken); 

            $.ajax({
                url: "{% url 'approve_timesheet' %}",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function (resp) {
                    if (resp.success) {
                        location.reload();
                    } else {
                        btn.prop('disabled', false).text('Approve');
                        showToast(resp.message || "Error approving", "danger");
                    }
                },
                error: function () {
                    btn.prop('disabled', false).text('Approve');
                    showToast("Server error", "danger");
                }
            });
        });

        // --- Bulk Approve ---
        $('#bulkApproveBtn').on('click', function () {
            const ids = $('.employee-checkbox:checked').map((_, el) => el.value).get();
            if (!ids.length) return;

            const btn = $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span>');

            const formData = new FormData();
            ids.forEach(id => {
                // Convert format: employeeId-year-week to employeeId-year-week+1
                const parts = id.split('-');
                if (parts.length === 3) {
                    const [empId, year, week] = parts;
                    formData.append('ids[]', `${empId}-${year}-${parseInt(week) + 1}`);
                } else {
                    formData.append('ids[]', id);
                }
            });
            formData.append('csrfmiddlewaretoken', csrftoken); 

            $.ajax({
                url: "{% url 'approve_selected_timesheets' %}",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function (resp) {
                    btn.html('Approve Selected');
                    if (resp.success) {
                        location.reload();
                    } else {
                        btn.prop('disabled', false);
                        showToast(resp.message || "Error approving selected", "danger");
                    }
                },
                error: function () {
                    btn.prop('disabled', false).html('Approve Selected');
                    showToast("Server error", "danger");
                }
            });
        });

        // --- Unapprove ---
        $(document).on('click', '.unapprove-btn', function (e) {
            e.preventDefault();
            const btn = $(this);
            const form = btn.closest('form'); 
            const tsheetId = btn.data('tsheet-id');

            btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span>');

            const url = form.attr('action');

            $.ajax({
                url: url,
                type: "POST",
                data: form.serialize(),
                success: function (resp) {
                    const nextUrl = new URL(url, window.location.origin).searchParams.get('next');
                    if (nextUrl) {
                        window.location.href = decodeURIComponent(nextUrl);
                    } else {
                        location.reload();
                    }
                },
                error: function () {
                    btn.prop('disabled', false).text('Back to Edit');
                    showToast("Server error", "danger");
                }
            });
        });

        // --- View Details ---
        $(document).on('click', '.view-details-btn', function () {
            const employeeId = $(this).data('employee-id');
            const employeeCode = $(this).data('employee-code');
            const selectedWeek = parseInt($(this).data('week'));
            const selectedYear = parseInt($(this).data('year'));
            const employeeName = $(this).data('employee-name');
            const weekStartDate = $(this).data('week-start');
            const weekEndDate = $(this).data('week-end');

            // Use the actual week start and end dates from backend
            const weekStart = new Date(weekStartDate);
            const weekEnd = new Date(weekEndDate);

            const weekStartStr = weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const weekEndStr = weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

            // Update the modal title
            const newTitle = `Timesheet - ${employeeCode} - ${employeeName} (${weekStartStr} - ${weekEndStr}, ${selectedYear})`;
            $('#weekDetailsModalLabel').text(newTitle);
            $('#weekDetailsModal .modal-body').html('<p class="text-center">Loading details...</p>');
            $('#weekDetailsModal').modal('show');

            $.ajax({
                url: '{% url "timesheet_week_details" %}',
                data: { employee_id: employeeId, year: selectedYear, week: selectedWeek + 1 }, // Convert to 1-based week
                dataType: 'json',
                success: function (resp) {
                    if (resp.success) {
                        let detailsHtml = '';
                        if (resp.entries?.length) {
                            resp.entries.forEach(function (day) {
                                const totalHrs = day.total_hours ?? day.hours ?? 0;

                                detailsHtml += `
                                    <div class="modal-day-section">
                                        <div class="day-header">
                                            <span>
                                                ${day.date_str} - ${day.day_name}
                                                ${day.is_holiday 
                                                    ? ` - <span style="color: #d64352;">Holiday - ${day.holiday_name || 'Holiday'}</span>` 
                                                    : day.is_leave 
                                                        ? ' - <span style="color: #a46fe5;">Leave</span>' 
                                                        : day.is_weekend 
                                                            ? '' 
                                                            : ''}
                                            </span>
                                            <span>${totalHrs} hrs</span>
                                        </div>
                                `;

                                if (day.timesheet_entries?.length) {
                                    day.timesheet_entries.forEach(function (entry) {
                                        detailsHtml += `
                                            <div class="entry-details">
                                                Project : ${entry.project_name || ''}  ${entry.costcenter_name || ''} - Hours : ${entry.hours}<br>
                                                Activity : ${entry.activity || 'N/A'} - Work Location : ${entry.work_location || 'N/A'}<br>
                                                Description : ${entry.description || 'N/A'}
                                            </div>
                                        `;
                                    });
                                }

                                detailsHtml += '</div>';
                            });
                        } else {
                            detailsHtml = '<p class="text-center">No entries, leaves, or holidays found for this week.</p>';
                        }
                        $('#weekDetailsModal .modal-body').html(detailsHtml);
                    } else {
                        $('#weekDetailsModal .modal-body').html('<p class="text-center text-danger">' + (resp.message || 'Error loading details.') + '</p>');
                    }
                },
                error: function () {
                    $('#weekDetailsModal .modal-body').html('<p class="text-center text-danger">Error loading details. Please try again.</p>');
                }
            });
        });
    });
</script>

{% endblock %}
